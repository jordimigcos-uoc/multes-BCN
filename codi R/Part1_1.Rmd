---
title: "Part II: projecte de visualització"
author: "Jordi Miguel i Costal"
date: "13/01/2026"
output:
  pdf_document:
    latex_engine: xelatex
    toc: true
    toc_depth: 3
    number_sections: true
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Carrega de paquets
```{r paquets}
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)
library(hms)
```

```{r rutes}
ruta_data <- file.path("..", "data")
ruta_denuncies <- file.path("..", "data", "denuncies")
#ruta_conceptes <- file.path("..", "data", "conceptes")
#ruta_codis <- file.path("..", "data", "codis")
#ruta_vehicle <- file.path("..", "data", "vehicle")
ruta_output <- file.path("..", "output")
```

# Unió i neteja de dades

## Informació de denúncies

```{r denuncies}
fitxers <- list.files(path = ruta_denuncies, pattern = "\\.csv$", full.names = TRUE)
print(fitxers)
```

Llegeim tots els CSV i els unim

```{r}
df_denuncies <- do.call(rbind, lapply(fitxers, read.csv))
```

```{r}
names(df_denuncies)

```
Eliminem columnes que no necessitarem

```{r}
df_denuncies <- df_denuncies %>%
  select(
    -Tipus_Via,
    -Desc_Tipus_Via,
    -Codi_Carrer,
    -Nom_Carrer,
    -Num_Carrer,
    -X_ETRS89,
    -Y_ETRS89,
    -Codi_Barri,
    -Nom_Barri,
    -Seccio_Censal,
    -Grua,
    -Codi_Districte,
    -Import_Nominal_.
  )
```

Eliminem valors nuls o 0

```{r}
df_denuncies <- df_denuncies %>%
  filter(
    # Hora_Infraccio no pot ser NA
    !is.na(Hora_Infraccio),
    
    # Longitud i Latitud no poden ser NA ni 0
    !is.na(Longitud_WGS84),
    !is.na(Latitud_WGS84),
    Longitud_WGS84 != 0,
    Latitud_WGS84 != 0,

    # MITJA_IMPOSICIO no pot ser NA ni buit ni 0
    !is.na(MITJA_IMPOSICIO),
    MITJA_IMPOSICIO != "",
    MITJA_IMPOSICIO != "0",

    # Tipus_Vehicle_Codi no pot ser NA ni buit ni 0
    !is.na(Tipus_Vehicle_Codi),
    Tipus_Vehicle_Codi != "",
    Tipus_Vehicle_Codi != "0"
  )
```

Trasnformem la columna Hora_Infraccio pero obtenir format hh:mm:ss

```{r}
df_denuncies <- df_denuncies %>%
  mutate(
    Hora_Infraccio_raw = Hora_Infraccio,  # guardem original
    Hora_Infraccio = str_pad(Hora_Infraccio, 6, pad = "0"),
    Hora_Infraccio = hms::as_hms(
      paste0(
        substr(Hora_Infraccio, 1, 2), ":",
        substr(Hora_Infraccio, 3, 4), ":",
        substr(Hora_Infraccio, 5, 6)
      )
    )
  ) %>%
  filter(
    !is.na(Hora_Infraccio),
    Hora_Infraccio != hms::as_hms("00:00:00")
  )
```

Canviem nom columnes

```{r}
df_denuncies <- df_denuncies %>%
  rename(
    lon = Longitud_WGS84,
    lat = Latitud_WGS84
  )
```

Afegim columna amb la franja horària de 60 minuts


```{r}
df_denuncies <- df_denuncies %>%
  mutate(
    # Convertim l'hora (hms) a POSIXct amb una data fictícia
    hora_posix = as.POSIXct(Hora_Infraccio, origin = "1970-01-01"),
    
    # Apliquem la franja de 60 minuts
    franja_hora  = floor_date(hora_posix, "60 minutes"),
    
    # Ens quedem només amb l'hora (sense data)
    franja_hora = format(franja_hora, "%H:%M")
  ) %>%
  select(-hora_posix)   # Eliminem la columna auxiliar

# Ordenem per franges horaries
df_denuncies <- df_denuncies %>%
  mutate(
    franja_hora = factor(
      franja_hora,
      levels = format(
        seq(
          from = as.POSIXct("00:00", format="%H:%M"),
          to   = as.POSIXct("23:45", format="%H:%M"),
          by   = "60 min"
        ),
        "%H:%M"
      )
    )
  )

```


```{r}
df_denuncies
names(df_denuncies)
```

# Ssancions per hora
```{r}
df_per_hora <- df_denuncies %>%
  mutate(Hora = substr(franja_hora, 1, 2)) %>%   # extreu "00" de "00:00"
  count(Hora, name = "total_multes") %>%
  arrange(Hora)
```

Guardem csv pel radialchart de sancions per hora

```{r}
write.csv(df_per_hora,
          file = file.path(ruta_output, "denuncies_hora.csv"),
          row.names = FALSE,
          quote = FALSE
          )
```

# Total per franja horaria i districte

```{r}
df_per_hora_districte <- df_denuncies %>%
  mutate(Hora = substr(franja_hora, 1, 2)) %>%   # converteix "00:00" → "00"
  count(Nom_Districte, Hora, name = "total_multes") %>%
  arrange(Nom_Districte, Hora)

df_per_hora_districte

```


```{r}
write.csv(df_per_hora_districte,
          file = file.path(ruta_output, "denuncies_hora_districte.csv"),
          row.names = FALSE,
          quote = FALSE
          )
```


# Classificació de vehicles

```{r}
df_denuncies <- df_denuncies %>%
  mutate(
    Grup_Vehicle = case_when(
      Tipus_Vehicle_Codi %in% c("B", "BA", "BI", "BT", "VT") ~ "Bicicletes",
      Tipus_Vehicle_Codi %in% c("AM") ~ "Equips emergencia",
      Tipus_Vehicle_Codi %in% c("VV") ~ "Habitatge",
      Tipus_Vehicle_Codi %in% c("CC", "CM", "CP", "M",
                            "MC", "TL", "VL")
                            ~ "Motocicleta",
      Tipus_Vehicle_Codi %in% c("MP", "MS","PT") ~ "Patinet",
      Tipus_Vehicle_Codi %in% c("TA") ~ "Taxis",
      Tipus_Vehicle_Codi %in% c("CL", "CT","F", "RI") ~ "Transport Comercial",
      Tipus_Vehicle_Codi %in% c("A", "AB", "AC", "AT", "MB") ~ "Transport públic",
      Tipus_Vehicle_Codi %in% c("MT", "QC", "R", "RT", "T", "TM",
                            "TT", "TU", "TY", "VM", "VP", "XL", "Y")
                            ~ "Vehicle Turisme",
      Tipus_Vehicle_Codi %in% c("G", "GI", "PC", "TR", "VE") ~ "Vehicles especials",
      Tipus_Vehicle_Codi %in% c("C", "VI") ~ "Vianants",
    )
  )


df_denuncies <- df_denuncies %>%
  filter(
    !is.na(Grup_Vehicle),           
    Grup_Vehicle != ""
  )

```

```{r}
df_per_vehicle_hora <- df_denuncies %>%
  mutate(Hora = substr(franja_hora, 1, 2)) %>%   # "00:00" → "00"
  count(Grup_Vehicle, Hora, name = "total_multes") %>%
  arrange(as.numeric(Hora), Grup_Vehicle)
df_per_vehicle_hora

```

```{r}
write.csv(df_per_hora_districte,
          file = file.path(ruta_output, "denuncies_vehicle.csv"),
          row.names = FALSE,
          quote = FALSE
          )
```

# Per hora i coordenades (50% superior)

```{r}
df_top50_hora_coords <- df_denuncies %>%
  mutate(hora = substr(franja_hora, 1, 2)) %>%      # "08:00" → "08"
  count(hora, lat, lon, name = "count") %>%         # multes per hora + coordenades
  group_by(hora) %>%
  arrange(desc(count), .by_group = TRUE) %>%        # ordena dins de cada hora
  mutate(rank = row_number(),
         total = n(),
         threshold = ceiling(total * 0.5)) %>%      # 50% superior
  filter(rank <= threshold) %>%                     # ens quedem només el top 50%
  select(-rank, -total, -threshold) %>%             # neteja
  ungroup()

df_top50_hora_coords
dim(df_top50_hora_coords)
```

```{r}
write.csv(df_top50_hora_coords,
          file = file.path(ruta_output, "denuncies_hora_coords.csv"),
          row.names = FALSE,
          quote = FALSE
          )
```



Coordenades, hora i vehicle

```{r}


df_top50_hora_coords_vehicle <- df_denuncies %>%
  mutate(hora = substr(franja_hora, 1, 2)) %>%        # "08:00" → "08"
  
  # Comptem multes per combinació d'hora + coordenades + grup de vehicle
  count(hora, lat, lon, Grup_Vehicle, name = "count") %>%
  
  # El filtratge del top 50% es fa dins de cada hora i grup de vehicle
  group_by(hora, Grup_Vehicle) %>%
  arrange(desc(count), .by_group = TRUE) %>%
  
  mutate(
    rank = row_number(),
    total = n(),
    threshold = ceiling(total * 0.5)   # top 50%
  ) %>%
  
  filter(rank <= threshold) %>%         # ens quedem només el top 50%
  select(-rank, -total, -threshold) %>% # neteja
  ungroup()



```

```{r}
df_top50_hora_coords_vehicle
```



```{r}
write.csv(df_top50_hora_coords_vehicle,
          file = file.path(ruta_output, "denuncies_hora_coords_vehicle.csv"),
          row.names = FALSE,
          quote = FALSE
          )
```

# Qui posa la multa

```{r}
df_denuncies <- df_denuncies %>%
  mutate(
    Agent = case_when(
      MITJA_IMPOSICIO %in% c("MTO") ~ "Radar",
      MITJA_IMPOSICIO %in% c("PGU", "BSM", "AGU") ~ "Guardia Urbana",
      MITJA_IMPOSICIO %in% c("CC") ~ "Papereta",
    )
  )


df_denuncies <- df_denuncies %>%
  filter(
    !is.na(Agent),           
    Agent != ""
  )

```


```{r}
df_top50_hora_coords_agent <- df_denuncies %>%
  mutate(hora = substr(franja_hora, 1, 2)) %>%        # "08:00" → "08"
  count(hora, lat, lon, Agent,
        name = "count") %>%                           # multes per hora + coords + vehicle
  group_by(hora, Agent) %>%              # filtrem dins de cada hora i vehicle
  arrange(desc(count), .by_group = TRUE) %>%          # ordena per multes
  mutate(rank = row_number(),
         total = n(),
         threshold = ceiling(total * 0.5)) %>%        # top 50%
  filter(rank <= threshold) %>%                       # ens quedem només el top
  select(-rank, -total, -threshold) %>%               # neteja
  ungroup()


```
```{r}
df_top50_hora_coords_agent
dim(df_top50_hora_coords_agent)
```

```{r}
write.csv(df_top50_hora_coords_agent,
          file = file.path(ruta_output, "denuncies_hora_coords_agent.csv"),
          row.names = FALSE,
          quote = FALSE
          )
```

# Totla per dia de la setmana i hora

```{r}
# Convertim Data_infraccio a Date
df_denuncies <- df_denuncies %>%
  mutate(
    Data_Infraccio = as.Date(Data_Infraccio)
  )

# Afegim dia de la setmana i mes
df_denuncies <- df_denuncies %>%
  mutate(
    dia_setmana = weekdays(Data_Infraccio, abbreviate = FALSE),
    mes = months(Data_Infraccio, abbreviate = FALSE)
  )


```


```{r}


df_setmana_dia <- df_denuncies %>%
  mutate(hora = substr(franja_hora, 1, 2)) %>%        # "08:00" → "08"
  
  # Comptem multes per combinació d'hora + coordenades + grup de vehicle
  count(dia_setmana, hora, name = "count")

```

```{r}
write.csv(df_setmana_dia,
          file = file.path(ruta_output, "denuncies_setm_dia.csv"),
          row.names = FALSE,
          quote = FALSE
          )
```

# Per Grup_vehivels per dia i per hora

```{r}
df_setmana_dia_vehicle <- df_denuncies %>%
  mutate(hora = substr(franja_hora, 1, 2)) %>%        # "08:00" → "08"
  
  # Comptem multes per combinació d'hora + coordenades + grup de vehicle
  count(dia_setmana, hora, Grup_Vehicle, name = "count")

```



```{r}
df_setmana_dia_vehicle
```

```{r}
write.csv(df_setmana_dia_vehicle,
          file = file.path(ruta_output, "denuncies_setm_dia_vehicle.csv"),
          row.names = FALSE,
          quote = FALSE
          )
```


# Per Agent per dia i per hora

```{r}
df_setmana_dia_agent <- df_denuncies %>%
  mutate(hora = substr(franja_hora, 1, 2)) %>%        # "08:00" → "08"
  
  # Comptem multes per combinació d'hora + coordenades + grup de vehicle
  count(dia_setmana, hora, Agent, name = "count")

```



```{r}
df_setmana_dia_agent
```

```{r}
write.csv(df_setmana_dia_agent,
          file = file.path(ruta_output, "denuncies_setm_dia_agent.csv"),
          row.names = FALSE,
          quote = FALSE
          )
```



